---
title: "survXAI"
author: "Aleksandra Grudziaz"
date: "`r Sys.Date()`"
output: html_document
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{survXAI}
  %\usepackage[UTF-8]{inputenc}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width='100%',
  warning = FALSE,
  message = FALSE
)
```

# Single prediction

In chosen time points we want to find out which variables support the "predicted" value of survival probability for new observation and which variables contradict it.

```{r}
library(survxai)
```
 
## Data and model
```{r}
library(rms)
library(randomForestSRC)

data(pbc, package = "randomForestSRC")
pbc <- pbc[complete.cases(pbc),]

predict_times <- function(model, new_observation, times){
  prob <- rms::survest(model, new_observation, times=times)$surv
  return(prob)
}

cph_model <- cph(Surv(days/365, status)~., data=pbc[1:300,], surv=TRUE, x = TRUE, y=TRUE)

```

## Explainer

```{r}
surve_cph <- explain(model = cph_model,
                  data = pbc,
                  y = Surv(pbc$days/365, pbc$status),
                  predict_function = predict_times)
```


## Object with predictions

```{r}
broken_list <- prediction_breakdown(surve_cph, pbc[1,], times = c(1,3,5))
```


###Plot survival curves

```{r}
 plot(broken_list)
```


## Variable response 
We want to describe how each variable level impact the value of survival probability in time.

### Variable response

```{r}
svr_cph <- variable_response(surve_cph, "sex")
plot(svr_cph)
```

For factor variable or numeric with few values we draw a survival curves for all values.


```{r}
svr_cph_group <- variable_response(surve_cph, "bili")
plot(svr_cph_group)
```

When we have a numerical variable with lots of values we plot not all values, because it might be difficult to read this plot, but we draw curves for quartiles.
In example above we have variable `bili` has over 80 unique values, but we draw only 5 curves.

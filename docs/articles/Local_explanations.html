<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Survival models - local explanations â€¢ survxai</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top navbar-mi2" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-mi2logo" href="http://mi2.mini.pw.edu.pl/">
        <img src="https://github.com/mi2-warsaw/MI2template/blob/master/inst/pkgdown/assets/MI2logo.jpg?raw=true" alt="MI2" height="46" title="MI2"></a>
      <a class="navbar-brand navbar-mi2" href="../index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="navbar-mi2 nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Custom_predict_for_survival_models.html">Custom predict function for survival models</a>
    </li>
    <li>
      <a href="../articles/Global_explanations.html">Survival models - global explanations</a>
    </li>
    <li>
      <a href="../articles/How_to_compare_models_with_survxai.html">How to compare models with survxai</a>
    </li>
    <li>
      <a href="../articles/Local_explanations.html">Survival models - local explanations</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Survival models - local explanations</h1>
                        <h4 class="author">Aleksandra Grudziaz</h4>
            
            <h4 class="date">2018-08-15</h4>
      
      
      <div class="hidden name"><code>Local_explanations.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Package <em>survxai</em> contains functions for creating a unified representation of a survival models. Such representations can be further processed by various survival explainers. Tools implemented in <em>survxai</em> help to understand how input variables are used in the model and what impact do they have on final model prediction.</p>
<p>The analyses carried out using this package can be divided into two parts: local analyses of new observations and global analyses showing the structures of survival models. This vignette describes local explanations.</p>
<p>Methods and functions in <em>survxai</em> package are based on <a href="https://github.com/pbiecek/DALEX"><em>DALEX</em> package</a>.</p>
</div>
<div id="use-case---data" class="section level1">
<h1 class="hasAnchor">
<a href="#use-case---data" class="anchor"></a>Use case - data</h1>
<div id="data-set" class="section level2">
<h2 class="hasAnchor">
<a href="#data-set" class="anchor"></a>Data set</h2>
<p>In our use case we will use the data from the Mayo Clinic trial in primary biliary cirrhosis (PBC) of the liver conducted between 1974 and 1984. A total of 424 PBC patients, referred to Mayo Clinic during that ten-year interval, met eligibility criteria for the randomized placebo controlled trial of the drug D-penicillamine. The first 312 cases in the data set participated in the randomized trial and contain largely complete data. The <code>pbc</code> data is included in the <a href="https://cran.r-project.org/web/packages/randomForestSRC/index.html"><em>randomForestSRC</em> package</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(pbc, <span class="dt">package =</span> <span class="st">"randomForestSRC"</span>)
pbc &lt;-<span class="st"> </span>pbc[<span class="kw">complete.cases</span>(pbc),]

<span class="kw">head</span>(pbc)</code></pre></div>
<pre><code>##   days status treatment   age sex ascites hepatom spiders edema bili chol
## 1  400      1         1 21464   1       1       1       1   1.0 14.5  261
## 2 4500      0         1 20617   1       0       1       1   0.0  1.1  302
## 3 1012      1         1 25594   0       0       0       0   0.5  1.4  176
## 4 1925      1         1 19994   1       0       1       1   0.5  1.8  244
## 5 1504      0         2 13918   1       0       1       1   0.0  3.4  279
## 7 1832      0         2 20284   1       0       1       0   0.0  1.0  322
##   albumin copper    alk   sgot trig platelet prothrombin stage
## 1    2.60    156 1718.0 137.95  172      190        12.2     4
## 2    4.14     54 7394.8 113.52   88      221        10.6     3
## 3    3.48    210  516.0  96.10   55      151        12.0     4
## 4    2.54     64 6121.8  60.63   92      183        10.3     4
## 5    3.53    143  671.0 113.15   72      136        10.9     3
## 7    4.09     52  824.0  60.45  213      204         9.7     3</code></pre>
<p>Our original data set contains only the numerical variables. For this usecase we convert variables <code>sex</code> and <code>stage</code> to factor variables.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pbc<span class="op">$</span>sex &lt;-<span class="st"> </span><span class="kw">as.factor</span>(pbc<span class="op">$</span>sex)
pbc<span class="op">$</span>stage &lt;-<span class="st"> </span><span class="kw">as.factor</span>(pbc<span class="op">$</span>stage)</code></pre></div>
</div>
<div id="models" class="section level2">
<h2 class="hasAnchor">
<a href="#models" class="anchor"></a>Models</h2>
<p>We will create Cox proportional hazards model based on five variables from our data set: <code>age</code>, <code>treatment</code>, <code>status</code>, <code>sex</code> and <code>bili</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1024</span>)
<span class="kw">library</span>(rms)
<span class="kw">library</span>(survxai)

pbc_smaller &lt;-<span class="st"> </span>pbc[,<span class="kw">c</span>(<span class="st">"days"</span>, <span class="st">"status"</span>, <span class="st">"treatment"</span>, <span class="st">"sex"</span>, <span class="st">"age"</span>, <span class="st">"bili"</span>, <span class="st">"stage"</span>)]
<span class="kw">head</span>(pbc_smaller)</code></pre></div>
<pre><code>##   days status treatment sex   age bili stage
## 1  400      1         1   1 21464 14.5     4
## 2 4500      0         1   1 20617  1.1     3
## 3 1012      1         1   0 25594  1.4     4
## 4 1925      1         1   1 19994  1.8     4
## 5 1504      0         2   1 13918  3.4     3
## 7 1832      0         2   1 20284  1.0     3</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cph_model &lt;-<span class="st"> </span><span class="kw">cph</span>(<span class="kw">Surv</span>(days<span class="op">/</span><span class="dv">365</span>, status)<span class="op">~</span>. , <span class="dt">data =</span> pbc_smaller, <span class="dt">surv =</span> <span class="ot">TRUE</span>, <span class="dt">x =</span> <span class="ot">TRUE</span>, <span class="dt">y=</span><span class="ot">TRUE</span>)</code></pre></div>
</div>
</div>
<div id="local-explanations" class="section level1">
<h1 class="hasAnchor">
<a href="#local-explanations" class="anchor"></a>Local explanations</h1>
<p>In this section we will focus on the local explanations - the explanations for chosen new observations.</p>
<div id="explainers" class="section level2">
<h2 class="hasAnchor">
<a href="#explainers" class="anchor"></a>Explainers</h2>
<p>First, we have to create survival explainers - objects to wrap-up the black-box model with meta-data. Explainers unify model interfacing.</p>
<p>We have to define custom predict function which takes three arguments: model, data and vector with time points. Predict funcions may vary depending on the model. Examples for some models are in <a href="">Explainations of different survival models vignette</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">predict_times &lt;-<span class="st"> </span><span class="cf">function</span>(model, data, times){
  prob &lt;-<span class="st"> </span>rms<span class="op">::</span><span class="kw"><a href="http://www.rdocumentation.org/packages/rms/topics/survest.cph">survest</a></span>(model, data, <span class="dt">times =</span> times)<span class="op">$</span>surv
  <span class="kw">return</span>(prob)
}

surve_cph &lt;-<span class="st"> </span><span class="kw"><a href="../reference/explain.html">explain</a></span>(<span class="dt">model =</span> cph_model,
                  <span class="dt">data =</span> pbc_smaller[,<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)], <span class="dt">y =</span> <span class="kw">Surv</span>(pbc_smaller<span class="op">$</span>days<span class="op">/</span><span class="dv">365</span>, pbc_smaller<span class="op">$</span>status),
                  <span class="dt">predict_function =</span> predict_times)

<span class="kw">print</span>(surve_cph)</code></pre></div>
<pre><code>## Model label:  coxph 
## Model class:  cph,rms,coxph 
## Data head  :
##   treatment sex   age bili stage
## 1         1   1 21464 14.5     4
## 2         1   1 20617  1.1     3</code></pre>
</div>
<div id="ceteris-paribus" class="section level2">
<h2 class="hasAnchor">
<a href="#ceteris-paribus" class="anchor"></a>Ceteris paribus</h2>
<p>Ceteris Paribus Plots (What-If Plots) are designed to present model responses around a single point in the feature space. For more details for generalised models of machine learning see: <a href="https://github.com/pbiecek/ceterisParibus" class="uri">https://github.com/pbiecek/ceterisParibus</a>.</p>
<p>Ceteris Paribus Plots for survival models are survival curves around one observation. Each curve represent observation with different value of chosen variable. For factor variables curves covers all possible values, for numeric variables values are divided into quantiles.</p>
<p>Ceteris Paribus Plot illustrates how will the survival curve change along with the changing variable.</p>
<p>Below, we plot Ceteris Paribus for one observation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">single_observation &lt;-<span class="st"> </span>pbc_smaller[<span class="dv">1</span>,<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)]
single_observation</code></pre></div>
<pre><code>##   treatment sex   age bili stage
## 1         1   1 21464 14.5     4</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">cp_cph &lt;-<span class="st"> </span><span class="kw"><a href="../reference/ceteris_paribus.html">ceteris_paribus</a></span>(surve_cph, single_observation)
<span class="kw">print</span>(cp_cph)</code></pre></div>
<pre><code>##       y_hat new_x     vname   x_quant quant relative_quant label      time
## 1 0.9789502     1 treatment 0.4927536     0     -0.4927536 coxph 0.1123288
## 2 0.9574511     1 treatment 0.4927536     0     -0.4927536 coxph 0.1397260
## 3 0.9360096     1 treatment 0.4927536     0     -0.4927536 coxph 0.1945205
## 4 0.9147630     1 treatment 0.4927536     0     -0.4927536 coxph 0.2109589
## 5 0.8929362     1 treatment 0.4927536     0     -0.4927536 coxph 0.3013699
## 6 0.8715713     1 treatment 0.4927536     0     -0.4927536 coxph 0.3589041
##     class
## 1 numeric
## 2 numeric
## 3 numeric
## 4 numeric
## 5 numeric
## 6 numeric</code></pre>
<p>After creating the <code>surv_ceteris_paribus</code> object we can visualize it in a very convinient way using the generic <code>plot()</code> function. Black line represent prediction of original observation.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(cp_cph, <span class="dt">scale_type =</span> <span class="st">"gradient"</span>, <span class="dt">scale_col =</span> <span class="kw">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>), <span class="dt">ncol =</span> <span class="dv">2</span>)</code></pre></div>
<p><img src="Local_explanations_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>We can see that there are differences for stages. Next, we will plot Ceteris Paribus for sigle variable <code>stage</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(cp_cph, <span class="dt">selected_variable =</span> <span class="st">"stage"</span>, <span class="dt">scale_type =</span> <span class="st">"gradient"</span>, <span class="dt">scale_col =</span> <span class="kw">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>))</code></pre></div>
<p><img src="Local_explanations_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>We see a trend that a lower <code>stage</code> means a higher probability of survival for chosen observation.</p>
</div>
<div id="prediction-breakdown" class="section level2">
<h2 class="hasAnchor">
<a href="#prediction-breakdown" class="anchor"></a>Prediction breakdown</h2>
<p>Break Down Plot presents variable contributions in final predictions. For more details for generalised models of machine learning see: <a href="https://github.com/pbiecek/breakDown" class="uri">https://github.com/pbiecek/breakDown</a>.</p>
<p>Break Down Plots for survival models compare differences in predictions for median of time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">broken_prediction_cph &lt;-<span class="st"> </span><span class="kw"><a href="../reference/prediction_breakdown.html">prediction_breakdown</a></span>(surve_cph, pbc_smaller[<span class="dv">1</span>,<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">2</span>)])
<span class="kw">print</span>(broken_prediction_cph)</code></pre></div>
<pre><code>##           contribution
## bili          -42.553%
## stage         -19.083%
## age            -5.153%
## treatment      -1.055%
## sex             0.354%</code></pre>
<p>After creating the <code>surv_prediction_breakdown</code> object we can visualize it in a very convinient way using the generic <code>plot()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>(broken_prediction_cph, <span class="dt">scale_col =</span> <span class="kw">c</span>(<span class="st">"red"</span>, <span class="st">"blue"</span>))</code></pre></div>
<p><img src="Local_explanations_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>This plot helps to understand the factors that drive survival probability for a single observation.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li>
<a href="#use-case---data">Use case - data</a><ul class="nav nav-pills nav-stacked">
<li><a href="#data-set">Data set</a></li>
      <li><a href="#models">Models</a></li>
      </ul>
</li>
      <li>
<a href="#local-explanations">Local explanations</a><ul class="nav nav-pills nav-stacked">
<li><a href="#explainers">Explainers</a></li>
      <li><a href="#ceteris-paribus">Ceteris paribus</a></li>
      <li><a href="#prediction-breakdown">Prediction breakdown</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Alicja Gosiewska, Aleksandra Grudziaz, Przemyslaw Biecek.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>

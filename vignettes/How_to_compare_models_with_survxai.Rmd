---
title: "How to compare models with survxai"
author: "Alicja Gosiewska"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
vignette: >
  %\VignetteEngine{knitr::knitr}
  %\VignetteIndexEntry{How to compare models with survxai}
  %\usepackage[UTF-8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```



# Introduction
Package *survxai* contains functions for creating a unified representation of a survival models. Such representations can be further processed by various survival explainers. Tools implemented in *survxai* help to understand how input variables are used in the model and what impact do they have on final model prediction.

The analyses carried out using this package can be divided into two parts: local analyses of new observations and global analyses showing the structures of survival models. This vignette describes local explanations.

Methods and functions in  *survxai* package are based on [*DALEX* package](https://github.com/pbiecek/DALEX). 

# Use case - data

## Data set
In use case we use the data from the Mayo Clinic trial in primary biliary cirrhosis (PBC) of the liver conducted between 1974 and 1984. A total of 424 PBC patients, referred to Mayo Clinic during that ten-year interval, met eligibility criteria for the randomized placebo controlled trial of the drug D-penicillamine. First 312 cases in the data set participated in the randomized trial and contain largely complete data.
The `pbc` data is included in the [*randomForestSRC* package](https://cran.r-project.org/web/packages/randomForestSRC/index.html).

In this vignette we base models on five variables from `pec` data set: `age`, `treatment`, `status`, `sex` and `bili`. For this purpouse we create a new data set `pbc_smaller`. We also change `days` for `years`.

```{r dataset}
data(pbc, package = "randomForestSRC")
pbc <- pbc[complete.cases(pbc),]
pbc_smaller <- pbc[,c("status", "treatment", "sex", "age", "bili", "stage")]
pbc_smaller$years <- pbc$days/365
head(pbc_smaller)
```

Original data set contains only the numerical variables. 
For this usecase we convert variables `sex` and `stage` to factor variables.

```{r}
pbc_smaller$sex <- as.factor(pbc_smaller$sex)
pbc_smaller$stage <- as.factor(pbc_smaller$stage)
```


## Models

We create 3 models: Cox Proportional Hazards Model, Random Forests for Survival, and Parametric Survival Regression Model.


### Cox Proportional Hazards Model

Cox proportional hazards model based on five variables from our data set: `age`, `treatment`, `status`, `sex` and `bili`.

```{r, models}
library(rms)

cph_model <- cph(Surv(years, status)~., data = pbc_smaller, surv = TRUE, x = TRUE, y=TRUE)
```

### Random Forests for Survival

```{r}
library(randomForestSRC)
set.seed(1994)
rf_model <- rfsrc(Surv(years, status)~., data = pbc_smaller)
```

### Parametric Survival Regression Model

```{r}
library(survival)
reg_model <- survreg(Surv(years, status)~., data = pbc_smaller, x = TRUE)
```

# Explanation

First, we have to create survival explainers - objects to wrap-up the black-box model with meta-data. Explainers unify model interfacing.

Some models require custom predict function. Examples are in [Explainations of different survival models vignette](https://mi2datalab.github.io/survxai/articles/Custom_predict_for_survival_models.html).

For `coxph()` and `rfsrc()` functions we have implemented prediction functions.
```{r}
library(survxai)

surve_cph <- explain(model = cph_model,
                     data = pbc_smaller[,-c(1,7)], 
                     y = Surv(pbc_smaller$years, pbc_smaller$status))

surve_rf <- explain(model = rf_model, 
                     label = "rf",
                     data = pbc_smaller[,-c(1,7)], 
                     y = Surv(pbc_smaller$years, pbc_smaller$status))
```

For model created by `survreg()` function we have to add specific custom predict function. 
We add this function to explainer by `predict_function` parameter.
```{r}
library(CFC)

custom_predict <- function(model, newdata, times){
  times <- sort(times)
  vars <- all.vars(model$call[[2]][[2]])
  n_vars <- which(colnames(newdata) %in% vars)
  if(length(n_vars)>0){
    newdata <- newdata[,-c(n_vars)]
  }
  model$x <- model.matrix(~., newdata)
  res <- matrix(ncol = length(times), nrow = nrow(newdata))
  for(i in 1:nrow(newdata)) {
    res[i,] <- cfc.survreg.survprob(t = times, args = model, n = i)    
  }
  return(res)
}

surve_reg <- explain(model = reg_model,
                     data = pbc_smaller[,-c(1,7)], 
                     y = Surv(pbc_smaller$years, pbc_smaller$status),
                     predict_function = custom_predict)

```


## Global explanations
At the beginning we are dealing with global explanations. We focus on explanations of the global and conditional model structure.

### Model performance
Currently, in the *survxai* package is implemented only the `BS` type of model performance.
In this metod for each time point we compute the prediction error for our model.
We compute `model_performance()` explainers for all three models created above.
```{r}
mp_cph <- model_performance(surve_cph)
mp_rf <- model_performance(surve_rf)
mp_reg <- model_performance(surve_reg)
```

We can plot all three models using generic `plot()` function.
```{r}
plot(mp_cph, mp_rf, mp_reg)
```

On the plot we see that the Cox Proportional Hazards Model and Parametric Survival Regression Model have simmilar performance - prediction errors for these models are almost the same. For the Survival Random Forest Model we have the smallest prediction errors.

### Variable response
Variable response explainers are designed to better understand the relation between a variable and a model output.
We compute `variable_response()` explainers for all three models created above.

#### Factor variable
Firstly we compute these type of explainers for the factor variable `sex`.
```{r}
vr_cph_sex <- variable_response(surve_cph, "sex")
vr_rf_sex <- variable_response(surve_rf, "sex")
vr_reg_sex <- variable_response(surve_reg, "sex")
```

We visualize our explainers on one plot.
```{r}
plot(vr_cph_sex, vr_rf_sex, vr_reg_sex)
```
We see that in all models patients with `sex=1` have higher probability of survival.

#### Continuous variable
We can also compute the `pdp` plots for numeric variables.
In this case we divide values of our variable `bili` into 6 intervals.
```{r}
vr_cph_bili <- variable_response(surve_cph, "bili")
vr_rf_bili <- variable_response(surve_rf, "bili")
vr_reg_bili <- variable_response(surve_reg, "bili")
```

```{r}
plot(vr_cph_bili, vr_rf_bili, vr_reg_bili)
```


## Local explanations
The next step in our analysis of machine learning models are local explanations - the explanations for one, new observation.

```{r}
single_observation <- pbc_smaller[1,-c(1,7)]
single_observation
```


### Ceteris paribus
Ceteris Paribus Plots for survival models are survival curves around one observation. Each curve represent observation with different value of chosen variable. For factor variables curves covers all possible values, for numeric variables values are divided into quantiles.
```{r}
cp_cph <- ceteris_paribus(surve_cph, single_observation)
cp_rf <- ceteris_paribus(surve_rf, single_observation)
cp_reg <- ceteris_paribus(surve_reg, single_observation)

```

```{r}
plot(cp_cph)
plot(cp_rf)
plot(cp_reg)
```

On the plots above we see that for variables `bili` and `sex` coxph and survreg model have simmilar performance, but randomForest model has different predictions for survival probability.

### Prediction breakdown
Break Down Plots for survival models compare, by default, differences in predictions for median of time. We can change the time of computing the contributions for each variable using `time` parameter. 
```{r}
broken_prediction_cph <- prediction_breakdown(surve_cph, single_observation)
broken_prediction_rf <- prediction_breakdown(surve_rf, single_observation)
broken_prediction_reg <- prediction_breakdown(surve_reg, single_observation)
```


```{r}
plot(broken_prediction_cph)
plot(broken_prediction_rf)
plot(broken_prediction_reg)
```

This plots helps to understand the factors that drive survival probability for a single observation.

For all models variable `bili` is the variable with the largest contribution. But the second variable is different randomForest (`age`) and coxph, survreg (`stage`). 

Also we can compute the variables contribution for chosen survival probability value.
```{r}
broken_prediction_cph <- prediction_breakdown(surve_cph, single_observation, prob = 0.8)
broken_prediction_rf <- prediction_breakdown(surve_rf, single_observation, prob = 0.8)
broken_prediction_reg <- prediction_breakdown(surve_reg, single_observation, prob = 0.8)
```

```{r}
plot(broken_prediction_cph)
plot(broken_prediction_rf)
plot(broken_prediction_reg)
```

We can compare this models on one plot, but for the transparency of the charts we have drawn them separately.
